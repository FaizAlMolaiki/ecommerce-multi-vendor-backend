{% extends 'dashboard/layouts/delete_layout.html' %}

{% block title %}حذف الكوبون - {{ object.code }} - لوحة التحكم{% endblock %}

{% with page_title='حذف الكوبون - '|add:object.code %}
{% with item_type='الكوبون' %}
{% with back_url='/dashboard/pricing/coupons/' %}
{% with cancel_url='/dashboard/pricing/coupons/' %}

{% block additional_content %}
<div class="row mb-3">
    <div class="col-md-6">
        <h6 class="text-muted">تفاصيل الكوبون:</h6>
        <div class="mb-3">
            <p class="mb-1"><strong><i class="fas fa-ticket-alt me-2"></i>{{ object.code }}</strong></p>
            <p class="mb-1"><strong>الحالة:</strong> 
                {% if object.active %}
                    <span class="badge bg-success">مفعل</span>
                {% else %}
                    <span class="badge bg-secondary">معطل</span>
                {% endif %}
            </p>
            {% if object.usage_limit %}
            <p class="mb-1"><strong>حد الاستخدام:</strong> {{ object.usage_limit }}</p>
            {% endif %}
            {% if object.limit_per_user %}
            <p class="mb-1"><strong>حد الاستخدام لكل مستخدم:</strong> {{ object.limit_per_user }}</p>
            {% endif %}
            {% if object.start_at %}
            <p class="mb-1"><strong>تاريخ البداية:</strong> {{ object.start_at|date:"Y-m-d H:i" }}</p>
            {% endif %}
            {% if object.end_at %}
            <p class="mb-1"><strong>تاريخ النهاية:</strong> {{ object.end_at|date:"Y-m-d H:i" }}</p>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <h6 class="text-warning">البيانات المرتبطة:</h6>
        <ul class="list-unstyled">
            <li><strong>مرات الاستخدام:</strong> 
                <span class="badge bg-info">{{ object.redemptions.count }}</span>
            </li>
            {% with promotion_count=object.promotion_rules.count offer_count=object.offer_rules.count %}
            {% with total_rules=promotion_count|add:offer_count %}
            <li><strong>القواعد المرتبطة:</strong> 
                <span class="badge bg-info">{{ total_rules }}</span>
            </li>
        </ul>
        
        {% if total_rules > 0 %}
        <h6 class="text-info mt-3">القواعد المرتبطة:</h6>
        <ul class="list-unstyled">
            {% for rule in object.promotion_rules.all %}
            <li class="mb-1">
                <small>
                    <i class="fas fa-percentage me-1"></i>{{ rule.name }} (خصم)
                    <span class="badge {% if rule.active %}bg-success{% else %}bg-secondary{% endif %} ms-1">
                        {% if rule.active %}مفعل{% else %}معطل{% endif %}
                    </span>
                </small>
            </li>
            {% endfor %}
            {% for rule in object.offer_rules.all %}
            <li class="mb-1">
                <small>
                    <i class="fas fa-gift me-1"></i>{{ rule.name }} (عرض)
                    <span class="badge {% if rule.active %}bg-success{% else %}bg-secondary{% endif %} ms-1">
                        {% if rule.active %}مفعل{% else %}معطل{% endif %}
                    </span>
                </small>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endwith %}
        {% endwith %}
        
        {% if object.redemptions.count > 0 %}
        <h6 class="text-success mt-3">إحصائيات الاستخدام:</h6>
        <ul class="list-unstyled">
            <li><small><strong>إجمالي الاستخدام:</strong> {{ object.redemptions.count }} مرة</small></li>
            <li><small><strong>آخر استخدام:</strong> {{ object.redemptions.first.redeemed_at|date:"Y-m-d H:i" }}</small></li>
        </ul>
        {% endif %}
    </div>
</div>

<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>تحذير مهم:</strong> 
    {% with promotion_count=object.promotion_rules.count offer_count=object.offer_rules.count %}
    {% with total_rules=promotion_count|add:offer_count %}
    {% if total_rules > 0 %}
        حذف هذا الكوبون سيؤثر على {{ total_rules }} قاعدة مرتبطة به. ستصبح هذه القواعد تلقائية (بدون كوبون مطلوب).
    {% else %}
        حذف هذا الكوبون نهائي ولا يمكن التراجع عنه.
    {% endif %}
    {% endwith %}
    {% endwith %}
    {% if object.redemptions.count > 0 %}
        <br>كما سيتم حذف سجل الاستخدام ({{ object.redemptions.count }} سجل).
    {% endif %}
</div>
{% endblock %}

{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}

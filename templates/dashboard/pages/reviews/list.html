{% extends 'dashboard/base/base.html' %}

{% block title %}التقييمات - لوحة التحكم{% endblock %}

{% block content %}
  {% include 'dashboard/includes/page_header.html' with page_title='التقييمات' page_subtitle='إدارة ومراجعة تقييمات المنتجات والمتاجر' page_icon='fas fa-star' %}

  <!-- Statistics Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      {% include 'dashboard/components/cards/stat_card.html' with title='إجمالي التقييمات' value=total_reviews icon='fa-star' color='primary' %}
    </div>
    <div class="col-md-3">
      {% include 'dashboard/components/cards/stat_card.html' with title='تقييمات المنتجات' value=product_reviews_count icon='fa-box' color='info' %}
    </div>
    <div class="col-md-3">
      {% include 'dashboard/components/cards/stat_card.html' with title='تقييمات المتاجر' value=store_reviews_count icon='fa-store' color='success' %}
    </div>
    <div class="col-md-3">
      {% include 'dashboard/components/cards/stat_card.html' with title='متوسط التقييم' value=average_rating icon='fa-star-half-alt' color='warning' subtitle='من 5' %}
    </div>
  </div>

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent border-0">
      <h5 class="card-title mb-0">
        <i class="fas fa-filter text-primary me-2"></i>فلترة التقييمات
      </h5>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-medium">بريد المستخدم</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
            <input class="form-control" type="text" name="email" value="{{ filters.email }}" placeholder="user@example.com">
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-medium">المنتج</label>
          <select class="form-select" name="product">
            <option value="">جميع المنتجات</option>
            {% for p in products %}
            <option value="{{ p.id }}" {% if filters.product == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-medium">المتجر</label>
          <select class="form-select" name="store">
            <option value="">جميع المتاجر</option>
            {% for s in stores %}
            <option value="{{ s.id }}" {% if filters.store == s.id|stringformat:'s' %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-medium">التقييم</label>
          <select class="form-select" name="rating">
            <option value="">جميع التقييمات</option>
            {% for r in '12345' %}
            <option value="{{ r }}" {% if filters.rating == r %}selected{% endif %}>{{ r }} نجوم</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-medium">النوع</label>
          <select class="form-select" name="type">
            <option value="">الكل</option>
            <option value="product" {% if filters.type == 'product' %}selected{% endif %}>تقييمات المنتجات</option>
            <option value="store" {% if filters.type == 'store' %}selected{% endif %}>تقييمات المتاجر</option>
          </select>
        </div>
        <div class="col-md-1">
          <button class="btn btn-primary w-100" type="submit">
            <i class="fas fa-search me-1"></i>بحث
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reviews Tables -->
  <div class="row g-3">
    <!-- Product Reviews -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="fas fa-box text-info me-2"></i>تقييمات المنتجات
            </h5>
            <span class="badge bg-info bg-opacity-10 text-info">{{ pr_page.paginator.count }} تقييم</span>
          </div>
        </div>
        <div class="card-body pt-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="border-0">المستخدم</th>
                  <th class="border-0">المنتج</th>
                  <th class="border-0 text-center">التقييم</th>
                  <th class="border-0">التاريخ</th>
                  <th class="border-0 text-center">الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for r in pr_page.object_list %}
                <tr>
                  <td>
                    {% if r.user %}
                    <div class="d-flex align-items-center">
                      <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                        <i class="fas fa-user text-primary small"></i>
                      </div>
                      <div>
                        <a href="{% url 'dashboard-user-detail' r.user.id %}" class="text-decoration-none fw-medium">{{ r.user.email }}</a>
                        <small class="text-muted d-block">مستخدم مسجل</small>
                      </div>
                    </div>
                    {% else %}
                    <div class="d-flex align-items-center">
                      <div class="bg-secondary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                        <i class="fas fa-user-times text-secondary small"></i>
                      </div>
                      <div>
                        <span class="text-muted">ضيف</span>
                        <small class="text-muted d-block">غير مسجل</small>
                      </div>
                    </div>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{% url 'dashboard-product-detail' r.product.id %}" class="text-decoration-none">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-cube text-info me-2"></i>
                        <span class="fw-medium">{{ r.product.name|truncatechars:30 }}</span>
                      </div>
                    </a>
                  </td>
                  <td class="text-center">
                    <div class="rating-stars">
                      {% for i in "12345" %}
                        {% if forloop.counter <= r.rating %}
                          <i class="fas fa-star text-warning"></i>
                        {% else %}
                          <i class="far fa-star text-muted"></i>
                        {% endif %}
                      {% endfor %}
                      <small class="text-muted d-block">{{ r.rating }}/5</small>
                    </div>
                  </td>
                  <td>
                    <small class="text-muted">{{ r.created_at|date:"d M Y" }}</small>
                    <small class="text-muted d-block">{{ r.created_at|date:"H:i" }}</small>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary btn-sm" title="عرض التفاصيل" onclick="showReviewDetails({{ r.id }}, 'product')">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" title="حذف" onclick="deleteReview({{ r.id }}, 'product')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-star fa-2x mb-2 d-block opacity-50"></i>
                    <h6>لا توجد تقييمات للمنتجات</h6>
                    <p class="small mb-0">لم يتم العثور على أي تقييمات للمنتجات</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if pr_page.paginator.num_pages > 1 %}
          <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
            <small class="text-muted">
              عرض {{ pr_page.start_index }}-{{ pr_page.end_index }} من {{ pr_page.paginator.count }} تقييم
            </small>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                {% if pr_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?pr_page={{ pr_page.previous_page_number }}&{{ request.GET.urlencode }}">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
                <li class="page-item active">
                  <span class="page-link">{{ pr_page.number }}</span>
                </li>
                {% if pr_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?pr_page={{ pr_page.next_page_number }}&{{ request.GET.urlencode }}">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Store Reviews -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="fas fa-store text-success me-2"></i>تقييمات المتاجر
            </h5>
            <span class="badge bg-success bg-opacity-10 text-success">{{ sr_page.paginator.count }} تقييم</span>
          </div>
        </div>
        <div class="card-body pt-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="border-0">المستخدم</th>
                  <th class="border-0">المتجر</th>
                  <th class="border-0 text-center">التقييم</th>
                  <th class="border-0">التاريخ</th>
                  <th class="border-0 text-center">الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for r in sr_page.object_list %}
                <tr>
                  <td>
                    {% if r.user %}
                    <div class="d-flex align-items-center">
                      <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                        <i class="fas fa-user text-primary small"></i>
                      </div>
                      <div>
                        <a href="{% url 'dashboard-user-detail' r.user.id %}" class="text-decoration-none fw-medium">{{ r.user.email }}</a>
                        <small class="text-muted d-block">مستخدم مسجل</small>
                      </div>
                    </div>
                    {% else %}
                    <div class="d-flex align-items-center">
                      <div class="bg-secondary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                        <i class="fas fa-user-times text-secondary small"></i>
                      </div>
                      <div>
                        <span class="text-muted">ضيف</span>
                        <small class="text-muted d-block">غير مسجل</small>
                      </div>
                    </div>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{% url 'dashboard-store-detail' r.store.id %}" class="text-decoration-none">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-store text-success me-2"></i>
                        <span class="fw-medium">{{ r.store.name|truncatechars:30 }}</span>
                      </div>
                    </a>
                  </td>
                  <td class="text-center">
                    <div class="rating-stars">
                      {% for i in "12345" %}
                        {% if forloop.counter <= r.rating %}
                          <i class="fas fa-star text-warning"></i>
                        {% else %}
                          <i class="far fa-star text-muted"></i>
                        {% endif %}
                      {% endfor %}
                      <small class="text-muted d-block">{{ r.rating }}/5</small>
                    </div>
                  </td>
                  <td>
                    <small class="text-muted">{{ r.created_at|date:"d M Y" }}</small>
                    <small class="text-muted d-block">{{ r.created_at|date:"H:i" }}</small>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary btn-sm" title="عرض التفاصيل" onclick="showReviewDetails({{ r.id }}, 'store')">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" title="حذف" onclick="deleteReview({{ r.id }}, 'store')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-store fa-2x mb-2 d-block opacity-50"></i>
                    <h6>لا توجد تقييمات للمتاجر</h6>
                    <p class="small mb-0">لم يتم العثور على أي تقييمات للمتاجر</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if sr_page.paginator.num_pages > 1 %}
          <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
            <small class="text-muted">
              عرض {{ sr_page.start_index }}-{{ sr_page.end_index }} من {{ sr_page.paginator.count }} تقييم
            </small>
            <nav>
              <ul class="pagination pagination-sm mb-0">
                {% if sr_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?sr_page={{ sr_page.previous_page_number }}&{{ request.GET.urlencode }}">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
                <li class="page-item active">
                  <span class="page-link">{{ sr_page.number }}</span>
                </li>
                {% if sr_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?sr_page={{ sr_page.next_page_number }}&{{ request.GET.urlencode }}">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_head %}
<style>
.rating-stars {
  font-size: 0.9rem;
}

.rating-stars i {
  margin-right: 1px;
}

.card-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 123, 255, 0.05);
}

@media (max-width: 768px) {
  .col-lg-6 {
    margin-bottom: 1rem;
  }
  
  .btn-group-sm .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
  }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add smooth animations to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = `all 0.6s ease ${index * 0.1}s`;
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100);
    });
    
    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.01)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
});

// Show review details in modal
function showReviewDetails(reviewId, type) {
    // Create modal for review details
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-star text-warning me-2"></i>تفاصيل التقييم
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Simulate loading review details
    setTimeout(() => {
        modal.querySelector('.modal-body').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted">معلومات التقييم</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p><strong>رقم التقييم:</strong> #${reviewId}</p>
                            <p><strong>النوع:</strong> ${type === 'product' ? 'تقييم منتج' : 'تقييم متجر'}</p>
                            <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted">نص التقييم</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0">هذا نص تقييم تجريبي. في التطبيق الحقيقي، سيتم جلب النص الفعلي للتقييم من قاعدة البيانات.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
    
    // Remove modal when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// Delete review with confirmation
function deleteReview(reviewId, type) {
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal fade';
    confirmModal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-trash me-2"></i>تأكيد الحذف
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h6>هل أنت متأكد من حذف هذا التقييم؟</h6>
                        <p class="text-muted">لا يمكن التراجع عن هذا الإجراء</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete(${reviewId}, '${type}')">
                        <i class="fas fa-trash me-1"></i>حذف
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmModal);
    const bsModal = new bootstrap.Modal(confirmModal);
    bsModal.show();
    
    // Remove modal when hidden
    confirmModal.addEventListener('hidden.bs.modal', () => {
        confirmModal.remove();
    });
}

// Confirm delete action
function confirmDelete(reviewId, type) {
    // Close confirmation modal
    const modal = document.querySelector('.modal.show');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
    
    // Show success message
    showToast(`تم حذف التقييم #${reviewId} بنجاح`, 'success');
    
    // In real application, make AJAX call to delete the review
    // Then refresh the page or remove the row from table
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    
    const icon = type === 'success' ? 'fa-check' : type === 'error' ? 'fa-times' : 'fa-info';
    toast.innerHTML = `<i class="fas ${icon} me-2"></i>${message}`;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
